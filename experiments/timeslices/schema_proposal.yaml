# VedaLang Schema Proposal: Timeslices
#
# This document proposes additions to vedalang.schema.json for timeslice support.
#
# Status: DRAFT
# Date: 2025-12-22
# Based on: experiments/timeslices/mini_plant_with_timeslices.tableir.yaml

# ============================================================================
# PROPOSED SCHEMA ADDITIONS
# ============================================================================

# Add to vedalang.schema.json $defs:

proposed_defs:
  timeslice_level:
    type: object
    description: "A single timeslice code within a level"
    required:
      - code
    properties:
      code:
        type: string
        pattern: "^[A-Z]{1,3}$"
        description: "Short code (1-3 chars) for this timeslice"
      name:
        type: string
        description: "Human-readable name (e.g., 'Summer', 'Day')"
      hours:
        type: number
        minimum: 0
        maximum: 24
        description: "Hours per day for DayNite level"
      days:
        type: integer
        minimum: 1
        maximum: 366
        description: "Days per year for Season level"

  timeslices:
    type: object
    description: "Timeslice structure for intra-annual variation"
    properties:
      season:
        type: array
        description: "Seasonal timeslice codes (e.g., Summer, Winter)"
        items:
          $ref: "#/$defs/timeslice_level"
      weekly:
        type: array
        description: "Weekly timeslice codes (rarely used)"
        items:
          $ref: "#/$defs/timeslice_level"
      daynite:
        type: array
        description: "Day/night timeslice codes"
        items:
          $ref: "#/$defs/timeslice_level"
      fractions:
        type: object
        description: "Year fraction for each composite timeslice (must sum to 1.0)"
        additionalProperties:
          type: number
          minimum: 0
          maximum: 1
        # Property names are auto-generated: SEASON + WEEKLY + DAYNITE
    additionalProperties: false

# Add to model properties:
#   timeslices:
#     $ref: "#/$defs/timeslices"
#     description: "Timeslice structure for temporal resolution"

# ============================================================================
# EXAMPLE USAGE
# ============================================================================

example_vedalang:
  model:
    name: TimesliceExample
    regions:
      - REG1
    
    timeslices:
      season:
        - code: S
          name: Summer
          days: 175
        - code: W
          name: Winter
          days: 190
      daynite:
        - code: D
          name: Day
          hours: 12
        - code: N
          name: Night
          hours: 12
      fractions:
        SD: 0.25
        SN: 0.23
        WD: 0.25
        WN: 0.27
    
    commodities:
      - name: ELC
        type: energy
    
    processes:
      - name: PP_CCGT
        sets: [ELE]

# ============================================================================
# COMPILER OUTPUT
# ============================================================================

# The compiler would emit:

compiled_tableir:
  files:
    - path: SysSettings/SysSettings.xlsx
      sheets:
        - name: sys-settings
          tables:
            - tag: "~TIMESLICES"
              rows:
                - season: S
                  weekly: ""
                  daynite: D
                - season: W
                  weekly: ""
                  daynite: N
        
        - name: constants
          tables:
            - tag: "~TFM_INS"
              rows:
                - timeslice: SD
                  attribute: YRFR
                  allregions: 0.25
                - timeslice: SN
                  attribute: YRFR
                  allregions: 0.23
                - timeslice: WD
                  attribute: YRFR
                  allregions: 0.25
                - timeslice: WN
                  attribute: YRFR
                  allregions: 0.27

# ============================================================================
# DESIGN DECISIONS
# ============================================================================

design_decisions:
  - name: "Explicit fractions vs auto-calculate"
    decision: "Require explicit fractions"
    rationale: |
      While fractions could be auto-calculated from days×hours, 
      real models often have more nuanced fraction definitions.
      Making them explicit ensures user intent is clear.
  
  - name: "Timeslice name generation"
    decision: "Auto-generate from concatenation"
    rationale: |
      VEDA/TIMES expects timeslice names to be SEASON+WEEKLY+DAYNITE.
      Auto-generating ensures consistency with VEDA conventions.
  
  - name: "Weekly level"
    decision: "Include but expect rarely used"
    rationale: |
      Most models use just Season+DayNite. Weekly is supported
      for completeness but can be omitted.

# ============================================================================
# VALIDATION RULES
# ============================================================================

validation_rules:
  - rule: "Fractions must sum to 1.0 (±0.001)"
    check: "sum(fractions.values()) ≈ 1.0"
    error: "Timeslice fractions must sum to 1.0"
  
  - rule: "Fraction keys must match generated timeslice names"
    check: "fractions.keys() == cross_product(season, weekly, daynite)"
    error: "Missing or extra timeslice in fractions"
  
  - rule: "If timeslices defined, at least one level must have entries"
    check: "len(season) > 0 or len(weekly) > 0 or len(daynite) > 0"
    error: "At least one timeslice level must be defined"

# ============================================================================
# FUTURE CONSIDERATIONS
# ============================================================================

future_work:
  - name: "Region-specific timeslices"
    description: |
      VEDA supports different timeslice structures per region.
      This is rare but could be supported with per-region overrides.
  
  - name: "Timeslice data references"
    description: |
      Other primitives (demand, availability) need to reference
      timeslices. Schema should define how to reference them.
  
  - name: "Dynamic timeslices"
    description: |
      TIMES supports dynamic timeslices that change over periods.
      This is advanced and not needed for initial VedaLang.
