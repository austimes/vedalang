# VedaLang Exploration Session Handoff
# Primitive: Demand & Demand Trajectories

veda_exploration_session:
  version: 1
  timestamp_utc: "2025-12-22T10:50:00Z"
  vedalang_schema_version: "main"
  issue_id: "vedalang-kpd"
  
  primitives_explored:
    - name: "demand_trajectories"
      status: "completed"
      
      focus_models:
        - file: "experiments/demand/model_demand_v1.veda.yaml"
          description: "Basic demand commodity and demand process (no projections)"
          veda_check_status: "SUCCESS"
          key_diagnostics:
            - "MISSING_TIMESLICES warning (expected)"
        
        - file: "experiments/demand/model_demand_v2_attempt.veda.yaml"
          description: "Attempted demand projection via commodity_price (wrong semantics)"
          veda_check_status: "SUCCESS"
          key_diagnostics:
            - "Compiles but emits COM_PRICE not COM_PROJ - semantically wrong"
        
        - file: "experiments/demand/demand_v3_tableir_manual.yaml"
          description: "Manually crafted TableIR with correct DEMAND attribute"
          veda_check_status: "SUCCESS"
          key_diagnostics:
            - "Validates pattern: ~FI_T with attribute=DEMAND maps to COM_PROJ"
      
      current_understanding:
        intent_summary: >
          Define exogenous final energy demands (DEM commodities) and their 
          evolution over time (COM_PROJ projections). Demands drive the model - 
          they are the requirements that supply-side processes must meet.
        
        expressible_with_current_schema: partial
        
        modeling_strategy_summary: >
          WHAT WORKS: Define demand commodities with type=demand (maps to DEM in Csets).
          Define demand devices with sets=[DMD] that take energy input and produce 
          demand output. This topology compiles correctly.
          
          WHAT DOESN'T WORK: Specifying the actual demand LEVELS (quantities) over time.
          The current schema only has commodity_price scenario type, which maps to 
          COM_PRICE (commodity pricing), not COM_PROJ (demand projections).
      
      schema_change_proposals:
        - id: "P-demand-001"
          status: "proposed"
          summary: "Add demand_projection scenario type"
          motivation: >
            To express demand levels (COM_PROJ), we need a new scenario type.
            The current commodity_price type emits to ~TFM_INS-TS with pset_co/cost
            columns which map to COM_PRICE. For demands, we need to emit to ~FI_T
            with attribute=DEMAND (or as scenario ~TFM_INS-TS with appropriate columns).
          
          minimal_required_changes:
            - "Add 'demand_projection' to scenario type enum in vedalang.schema.json"
            - "Add conditional schema requiring 'commodity', 'values', 'interpolation' for demand_projection"
            - "Extend compiler._compile_scenario() to handle demand_projection type"
            - "Emit ~FI_T rows with attribute=DEMAND, commodity, year, value"
          
          example_syntax: |
            scenarios:
              - name: BaseDemand
                type: demand_projection
                commodity: RSD
                interpolation: interp_extrap
                values:
                  "2020": 100.0
                  "2030": 120.0
                  "2040": 140.0
                  "2050": 160.0
          
          veda_emission_pattern: |
            # Emit to ~FI_T table (same file as processes, or scenario file)
            - tag: ~FI_T
              rows:
                - attribute: DEMAND
                  commodity: RSD
                  year: 2020
                  value: 100.0
                - attribute: DEMAND
                  commodity: RSD
                  year: 2030
                  value: 120.0
                # etc.
  
  global_learnings:
    - "COM_PROJ (demand projection) is a commodity attribute, not a process attribute"
    - "VEDA 'DEMAND' attribute in ~FI_T maps to TIMES 'COM_PROJ' parameter"
    - "Demand projections can go in base files (~FI_T) or scenario files"
    - "The commodity_price scenario type is NOT suitable for demand projections (different semantics)"
    - "DEM commodity set works correctly with type=demand in VedaLang"
  
  open_questions:
    - "Should demand projections be base-year anchored with growth rates, or explicit levels?"
    - "Should demand projections go to ~FI_T or to ~TFM_DINS (scenario demand insert)?"
    - "How to handle demand aggregation (~COMAGG) if needed?"
  
  next_actions:
    - primitive: "demand_trajectories"
      description: "Implement demand_projection scenario type per proposal P-demand-001"
    - primitive: "demand_trajectories" 
      description: "Create test case in tests/ for demand projection compilation"
