# Session Handoff: Storage Process Exploration
# Date: 2025-12-22
# Issue: vedalang-1ak

session:
  date: "2025-12-22"
  issue: vedalang-1ak
  goal: Determine if VedaLang can express storage processes with same commodity I/O

primitives_explored:
  - name: Storage (Energy Shifting)
    status: EXPRESSIBLE
    description: |
      Storage processes shift energy across time - the same commodity goes in
      and comes out, with round-trip efficiency losses. Examples: batteries,
      pumped hydro, thermal storage.
    
    key_questions_answered:
      can_have_same_commodity_in_and_out: true
      schema_allows_pattern: true
      xl2times_accepts_structure: true
      requires_timeslices_for_full_behavior: true  # Warning but not blocking
    
    modeling_approach:
      description: |
        Use the same commodity in both inputs and outputs arrays. The efficiency
        field represents round-trip efficiency (losses from charging + discharging).
      example: |
        inputs:
          - commodity: ELC
            share: 1.0
        outputs:
          - commodity: ELC
            share: 1.0
        efficiency: 0.85  # Round-trip efficiency

focus_models:
  - path: experiments/storage/model_storage_v1.veda.yaml
    description: Grid-scale battery storage with ELC in/out and 85% efficiency
    validation_status: PASS
    validation_details:
      errors: 0
      warnings: 1
      warning_codes: [MISSING_TIMESLICES]
    tables_generated:
      - "~BOOKREGIONS_MAP"
      - "~STARTYEAR"
      - "~ACTIVEPDEF"
      - "~TIMEPERIODS"
      - "~CURRENCIES"
      - "~FI_COMM"
      - "~FI_PROCESS"
      - "~FI_T"
    compiled_topology:
      description: |
        The ~FI_T table correctly contains for STG_BATTERY:
        - Input row: ELC with share-i: 1.0
        - Output row: ELC with share-o: 1.0
        - Efficiency row: eff: 0.85
        
        Key observation: The SAME commodity (ELC) appears in both commodity-in
        and commodity-out columns - xl2times accepts this topology.

current_understanding:
  intent_summary: |
    VedaLang users want to model storage technologies that shift energy across
    time periods. The key characteristic is that input and output are the same
    commodity (e.g., electricity in → electricity out with losses).
  
  expressibility_assessment: FULLY_EXPRESSIBLE
  
  pattern_differences:
    vs_generation: |
      Generation processes transform commodities (NG → ELC).
      Storage processes shift the SAME commodity across time (ELC → ELC).
    vs_chp: |
      CHP has multiple DIFFERENT output commodities (ELC + HEAT).
      Storage has ONE commodity that is both input and output.
  
  timeslice_implications:
    description: |
      Storage is physically meaningful only with timeslices - it shifts energy
      from one timeslice to another (e.g., afternoon solar → evening demand).
      Without timeslices, storage reduces to a simple efficiency loss.
    current_status: |
      xl2times issues MISSING_TIMESLICES warning but still accepts the model.
      The topology is valid; timeslice behavior is a separate concern.
    future_work: |
      Adding timeslice definitions to VedaLang is tracked as a future phase.
      This is an additive enhancement, not a blocker for current expressibility.

  process_sets:
    observation: |
      Used sets: [ELE] for the storage process. This works but may not be
      semantically correct. TIMES has dedicated STG process set for storage.
    recommendation: |
      Consider whether VedaLang should have explicit storage process type
      or allow STG in sets. Current approach works but is informal.

schema_change_proposals: []
  # No schema changes needed - current schema is sufficient for storage topology

potential_enhancements:
  - name: Timeslice definitions
    priority: high
    description: |
      Adding timeslice support to VedaLang would enable proper temporal storage
      modeling. This is tracked in design phase P4.
    status: planned_future_phase
  
  - name: Storage-specific process type
    priority: low
    description: |
      Could add explicit storage process type with storage-specific attributes
      (charge rate, discharge rate, storage capacity vs power capacity).
    status: not_needed_for_mvp
  
  - name: Same-commodity validation warning
    priority: low
    description: |
      Could optionally warn when a process has same commodity in inputs and
      outputs to flag potential modeling errors (though this is valid for storage).
    status: not_recommended

next_actions:
  - action: Close issue vedalang-1ak as resolved
    reason: Storage topology is fully expressible with current schema
  
  - action: Add storage pattern to rules/patterns.yaml
    reason: Document the storage pattern for future reference
    priority: medium
  
  - action: Track timeslice support as future enhancement
    reason: Required for proper temporal storage behavior
    priority: high
    tracking: design_phase_P4

artifacts_created:
  - experiments/storage/model_storage_v1.veda.yaml
  - experiments/handoff/session_2025-12-22_storage.yaml

test_commands:
  validate_model: |
    uv run veda_check experiments/storage/model_storage_v1.veda.yaml --from-vedalang --json
  inspect_topology: |
    uv run python -c "
    from pathlib import Path
    from vedalang.compiler import load_vedalang, compile_vedalang_to_tableir
    source = load_vedalang(Path('experiments/storage/model_storage_v1.veda.yaml'))
    tableir = compile_vedalang_to_tableir(source)
    for f in tableir['files']:
      for s in f['sheets']:
        for t in s['tables']:
          if t['tag'] == '~FI_T':
            for row in t['rows']: print(row)
    "
