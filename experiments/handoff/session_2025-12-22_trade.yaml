# Session Handoff: Trade Between Regions Exploration
# Date: 2025-12-22
# Issue: vedalang-87e

session:
  date: "2025-12-22"
  issue: "vedalang-87e"
  focus: "Inter-regional trade (IRE processes)"

summary: |
  Explored whether VedaLang can express inter-regional trade.
  
  VERDICT: Trade requires VedaLang schema extension.
  Current VedaLang has no way to express bi-regional topology.

key_discoveries:
  - name: TRADELINKS table structure
    detail: |
      VEDA uses ~TRADELINKS (matrix) or ~TRADELINKS_DINS (normalized) tables.
      Matrix format: sheet name = "Bi_COMMODITY" or "Uni_COMMODITY"
      Normalized: reg1, reg2, comm, comm1, comm2, process, tradelink columns.
  
  - name: Trade process auto-generation
    detail: |
      xl2times auto-creates IRE processes from TRADELINKS tables.
      Naming: T{B|U}_{COMM}_{REG1}_{REG2}_## 
      Processes belong to IRE set in BOTH regions.
  
  - name: TOP_IRE output structure
    detail: |
      (Origin, CommodityIn, Destination, CommodityOut, Process)
      Bidirectional trade creates TWO entries (one per direction).
  
  - name: File convention
    detail: |
      Trade files: SuppXLS/Trades/ScenTrade__Trade_Links.xlsx
      Trade params: SuppXLS/Trades/ScenTrade_TRADE_PARAM.xlsx

validated_patterns:
  - name: miniveda2_with_trade
    path: experiments/trade/miniveda2_with_trade/
    description: |
      Extended MiniVEDA2 with REG2 and bidirectional ELC trade.
      Successfully processed by xl2times - TOP_IRE generated correctly.
    status: SUCCESS

failed_experiments:
  - name: v1_workaround
    path: experiments/trade/v1_workaround.veda.yaml
    reason: VedaLang cannot express bi-regional topology
    
  - name: v2_tableir_trade  
    path: experiments/trade/v2_tableir_trade.yaml
    reason: SysSettings table format complexity (scalar tables)
    
  - name: v3_tableir_trade
    path: experiments/trade/v3_tableir_trade.yaml
    reason: Same SysSettings issues

schema_changes_needed:
  - field: model.trade_links
    type: array
    items:
      origin: string (region code)
      destination: string (region code)
      commodity: string (commodity name)
      bidirectional: boolean (default false)
      efficiency: number (optional, 0-1, maps to IRE_FLO)
      capacity: number (optional, maps to NCAP_BND)
    
  - compiler_changes:
      - Lower trade_links to ~TRADELINKS_DINS table
      - Place in SuppXLS/Trades/ScenTrade__Trade_Links.xlsx
      - Auto-generate process names if not provided

next_steps:
  - priority: HIGH
    action: Add trade_links to vedalang.schema.json
    
  - priority: HIGH
    action: Implement trade_links lowering in compiler
    
  - priority: MEDIUM
    action: Add trade efficiency (IRE_FLO) support
    
  - priority: LOW
    action: Add trade capacity bounds support

files_created:
  - experiments/trade/README.md
  - experiments/trade/v1_workaround.veda.yaml
  - experiments/trade/v2_tableir_trade.yaml
  - experiments/trade/v3_tableir_trade.yaml
  - experiments/trade/miniveda2_with_trade/ (copied + extended MiniVEDA2)
  - experiments/handoff/session_2025-12-22_trade.yaml

context_for_next_session: |
  The miniveda2_with_trade/ directory contains a working two-region model
  with bidirectional electricity trade. Use this as reference for:
  1. How VT_REG*_*.xlsx files define internal regions
  2. How ScenTrade__Trade_Links.xlsx matrix format works
  3. What TOP_IRE output looks like for valid trade
  
  The xl2times transforms.py has the trade processing logic:
  - harmonise_tradelinks(): converts matrix to normalized
  - process_tradelinks(): creates model.trade
  - complete_model_trade(): adds external trade (IMP/EXP)
