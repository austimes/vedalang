# VedaLang Exploration Session Handoff
# Primitive: Capacity Bounds (CAP_BND, NCAP_BND)

veda_exploration_session:
  version: 1
  timestamp_utc: "2025-12-22T21:00:00Z"
  vedalang_schema_version: "main"
  issue_id: "vedalang-381"
  
  primitives_explored:
    - name: "capacity_bounds"
      status: "completed"
      
      focus_models:
        - file: "experiments/capacity_bounds/tableir_cap_bounds_v2.yaml"
          description: "Basic CAP_BND and NCAP_BND (must combine with topology)"
          veda_check_status: "SUCCESS"
          key_learnings:
            - "Bounds must be on rows with topology (eff, comm-in, comm-out)"
            - "CAP_BND and NCAP_BND use same limtype column as ACT_BND"
        
        - file: "experiments/capacity_bounds/tableir_cap_bounds_v3_timevarying.yaml"
          description: "Time-varying NCAP_BND (year-specific limits)"
          veda_check_status: "SUCCESS"
          key_learnings:
            - "Year column works to specify period-specific limits"
            - "Separate rows per year for time-varying bounds"
        
        - file: "experiments/capacity_bounds/tableir_cap_bounds_v4_limtypes.yaml"
          description: "All limtypes: UP, LO, FX"
          veda_check_status: "SUCCESS"
          key_learnings:
            - "UP (upper), LO (lower), FX (fixed) all validate"
            - "LO useful for minimum renewable targets (RPS)"
            - "FX useful for existing/legacy capacity"
        
        - file: "experiments/capacity_bounds/tableir_cap_bounds_v5_combined.yaml"
          description: "Combined CAP_BND + NCAP_BND on same process"
          veda_check_status: "SUCCESS"
          key_learnings:
            - "Both CAP_BND and NCAP_BND can apply to same process"
            - "Separate rows needed (each uses limtype)"
      
      current_understanding:
        intent_summary: >
          Limit capacity deployment through upper bounds (market limits, grid 
          constraints), lower bounds (renewable targets, must-build), or fixed 
          values (existing legacy plants). Bounds can apply to total installed 
          capacity (CAP_BND) or new additions per period (NCAP_BND).
        
        expressible_with_current_schema: false
        
        what_works:
          - "All bound patterns validate through xl2times when in ~FI_T"
          - "limtype column: UP, LO, FX all work"
          - "cap_bnd, ncap_bnd, act_bnd columns all validate"
          - "Year-specific bounds work (year column + bound value)"
          - "Multiple bound types on same process (via separate rows)"
        
        what_does_not_work:
          - "VedaLang schema has no bound attributes on processes"
          - "No limtype support in schema"
          - "No time-varying bound support (year-specific limits)"
        
        modeling_strategy_summary: >
          All capacity bound patterns tested validate through xl2times.
          The VEDA pattern is consistent: limtype column + bound value column
          on a row that also has topology (eff, comm-in, or comm-out).
          Year-specific bounds use the year column on separate rows.
  
  vedalang_014_assessment:
    issue_id: "vedalang-014"
    current_scope: >
      Proposes: activity_bound_up, cap_bound_up, ncap_bound_up as simple
      scalar attributes on processes. No lower/fixed bounds, no time-varying.
    
    gaps_identified:
      - gap: "No lower bounds (LO)"
        use_case: "Renewable portfolio standards, must-build policies"
        priority: "medium"
        recommendation: "Add activity_bound_lo, cap_bound_lo, ncap_bound_lo"
      
      - gap: "No fixed bounds (FX)"
        use_case: "Existing/legacy plant capacity, predetermined builds"
        priority: "low"
        recommendation: "Add activity_bound_fx, cap_bound_fx, ncap_bound_fx"
      
      - gap: "No time-varying bounds"
        use_case: "Increasing deployment limits over time (2 GW/yr â†’ 5 GW/yr)"
        priority: "medium"
        recommendation: "Use time_series pattern (like demand_projection)"
    
    recommendation: >
      Expand vedalang-014 to include all three limtypes (UP, LO, FX). 
      Time-varying bounds should follow the time_series pattern already 
      defined in schema (with interpolation modes). This keeps bounds
      consistent with other time-varying parameters.
  
  schema_change_proposals:
    - id: "P-bounds-001-revised"
      status: "proposed"
      priority: "high"
      summary: "Add complete capacity and activity bounds to processes"
      
      replaces: "P-bounds-001 from vedalang-014"
      
      motivation: >
        Capacity bounds are fundamental to realistic energy modeling. Upper
        bounds represent market/resource limits. Lower bounds represent policy
        mandates (RPS). Fixed bounds represent existing assets. Time-varying
        bounds allow changing limits across model horizon.
      
      minimal_required_changes:
        - "Add to process schema: activity_bound (object with up/lo/fx keys)"
        - "Add to process schema: cap_bound (object with up/lo/fx keys)"
        - "Add to process schema: ncap_bound (object with up/lo/fx keys)"
        - "Each bound can be number (scalar) OR time_series (year-varying)"
        - "Emit as limtype + act_bnd/cap_bnd/ncap_bnd columns in ~FI_T"
      
      example_syntax_simple: |
        # Simple scalar bounds (most common case)
        processes:
          - name: PP_CCGT
            sets: [ELE]
            inputs:
              - commodity: NG
            outputs:
              - commodity: ELC
            efficiency: 0.55
            cap_bound:
              up: 10.0      # Max 10 GW total capacity
            ncap_bound:
              up: 2.0       # Max 2 GW new per period
      
      example_syntax_full: |
        # All bound types
        processes:
          - name: PP_WIND
            sets: [ELE]
            outputs:
              - commodity: ELC
            cap_bound:
              lo: 5.0       # Minimum 5 GW (RPS target)
              up: 50.0      # Maximum 50 GW (grid limit)
            ncap_bound:
              up: 5.0       # Max 5 GW new per period
          
          - name: PP_EXIST
            sets: [ELE]
            outputs:
              - commodity: ELC
            ncap_bound:
              fx: 3.0       # Exactly 3 GW (existing plant)
      
      example_syntax_timevarying: |
        # Time-varying bounds (increasing deployment limit)
        processes:
          - name: PP_SOLAR
            sets: [ELE]
            outputs:
              - commodity: ELC
            ncap_bound:
              up:
                interpolation: interp_extrap
                values:
                  2020: 2.0   # Max 2 GW new build in 2020
                  2030: 5.0   # Max 5 GW new build in 2030
                  2040: 10.0  # Max 10 GW new build in 2040
      
      veda_emission_pattern: |
        # Scalar bound
        - tag: ~FI_T
          rows:
            - techname: PP_CCGT
              eff: 0.55
              limtype: UP
              cap_bnd: 10.0
        
        # Time-varying bound (one row per year)
        - tag: ~FI_T
          rows:
            - techname: PP_SOLAR
              eff: 1.0
              year: 2020
              limtype: UP
              ncap_bnd: 2.0
            - techname: PP_SOLAR
              eff: 1.0
              year: 2030
              limtype: UP
              ncap_bnd: 5.0
  
  veda_patterns_validated:
    - pattern: "Total capacity upper bound (CAP_BND UP)"
      description: "Maximum total installed capacity across all vintages"
      tables: ["~FI_T"]
      columns: ["limtype", "cap_bnd"]
      example_row: "techname: PP_CCGT, eff: 0.55, limtype: UP, cap_bnd: 10.0"
    
    - pattern: "New capacity upper bound (NCAP_BND UP)"
      description: "Maximum new capacity additions per period"
      tables: ["~FI_T"]
      columns: ["limtype", "ncap_bnd"]
      example_row: "techname: PP_WIND, commodity-out: ELC, limtype: UP, ncap_bnd: 2.0"
    
    - pattern: "Capacity lower bound (CAP_BND LO)"
      description: "Minimum required capacity (RPS, must-build)"
      tables: ["~FI_T"]
      columns: ["limtype", "cap_bnd"]
      example_row: "techname: PP_WIND, eff: 1.0, limtype: LO, cap_bnd: 5.0"
    
    - pattern: "Fixed new capacity (NCAP_BND FX)"
      description: "Exactly specified new capacity (existing plants)"
      tables: ["~FI_T"]
      columns: ["limtype", "ncap_bnd"]
      example_row: "techname: PP_EXIST, eff: 1.0, limtype: FX, ncap_bnd: 3.0"
    
    - pattern: "Time-varying NCAP_BND"
      description: "Year-specific deployment limits"
      tables: ["~FI_T"]
      columns: ["year", "limtype", "ncap_bnd"]
      example_row: "techname: PP_SOLAR, eff: 1.0, year: 2030, limtype: UP, ncap_bnd: 5.0"
    
    - pattern: "Combined CAP_BND + NCAP_BND"
      description: "Both total and per-period limits on same process"
      tables: ["~FI_T"]
      notes: "Separate rows needed, each with limtype"
  
  global_learnings:
    - "Bounds use limtype column with UP/LO/FX, same pattern as ACT_BND"
    - "Bound rows must include topology (eff, comm-in, or comm-out)"
    - "Year column enables time-varying bounds (one row per year)"
    - "Multiple bound types on same process require separate rows"
    - "CAP_BND limits total capacity, NCAP_BND limits per-period additions"
    - "FX bounds useful for modeling existing/legacy capacity"
    - "LO bounds useful for policy mandates (RPS, must-build)"
  
  open_questions:
    - "Should time-varying bounds use same time_series pattern as demand_projection?"
    - "How to handle vintage-specific capacity (NCAP in specific past year)?"
    - "Should we support NCAP_DISC (discrete capacity units)?"
    - "How to express capacity growth rates (e.g., max 20% growth per period)?"
  
  next_actions:
    - primitive: "capacity_bounds"
      action: "update_issue"
      description: "Update vedalang-014 with expanded scope (LO, FX, time-varying)"
    
    - primitive: "capacity_bounds"
      action: "implement"
      description: "Implement P-bounds-001-revised when costs (vedalang-m2k, vedalang-86j) are done"
